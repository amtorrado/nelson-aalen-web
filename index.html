<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AnÃ¡lisis de Confiabilidad â€” Nelson-Aalen</title>

  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

</head>
<body style="background:#1c2b2b;color:white;font-family:Arial;padding:20px;">

<h2>AnÃ¡lisis de Confiabilidad â€” Nelson-Aalen</h2>

<input type="text" id="nombre-rack" placeholder="Nombre del equipo (opcional)" style="width:100%;padding:10px;margin-bottom:10px;">

<textarea id="horas-input" rows="3" placeholder="Ej: 120, 340, 780, 1200"
style="width:100%;padding:10px;margin-bottom:10px;"></textarea>

<button onclick="ejecutarAnalisis()" id="btn-analizar">Cargando motor...</button>

<div id="error-msg" style="color:red;margin-top:10px;"></div>

<div id="resultados" style="display:none;margin-top:30px;">
  <h3 id="titulo"></h3>
  <p><strong>Fallas:</strong> <span id="res-fallas"></span></p>
  <p><strong>Tiempo mÃ¡ximo:</strong> <span id="res-tiempo"></span></p>
  <p><strong>Riesgo acumulado:</strong> <span id="res-riesgo"></span></p>
  <p><strong>Comportamiento:</strong> <span id="res-comportamiento"></span></p>

  <div id="grafico" style="height:500px;"></div>
</div>

<script>
let pyodide = null;

async function cargarPyodide() {
  pyodide = await loadPyodide();
  await pyodide.loadPackage(["numpy"]);   // âœ… SOLO NUMPY
  document.getElementById("btn-analizar").innerText = "Analizar";
}
cargarPyodide();

const codigoPython = `
import numpy as np
import json

def analizar(tiempos_str):
    tiempos = sorted([float(x.strip()) for x in tiempos_str.split(",") if x.strip()])
    n = len(tiempos)

    if n < 3:
        raise ValueError("Se requieren al menos 3 datos")
    if any(t <= 0 for t in tiempos):
        raise ValueError("Los tiempos deben ser positivos")

    H = list(np.cumsum([1/(n-i) for i in range(n)]))

    # Ajuste lineal
    slope, intercept = np.polyfit(tiempos, H, 1)
    linea_lineal = np.polyval([slope, intercept], tiempos)

    ss_res = np.sum((np.array(H) - linea_lineal)**2)
    ss_tot = np.sum((np.array(H) - np.mean(H))**2)
    r2_lineal = 1 - (ss_res/ss_tot) if ss_tot > 0 else 1.0

    # Ajuste polinomial
    coef = np.polyfit(tiempos, H, 2)
    linea_poly = np.polyval(coef, tiempos)
    ss_res2 = np.sum((np.array(H) - linea_poly)**2)
    r2_poly = 1 - (ss_res2/ss_tot) if ss_tot > 0 else 1.0

    a = coef[0]

    if abs(r2_poly - r2_lineal) < 0.01:
        comportamiento, emoji = "LINEAL", "ðŸŸ¡"
    elif a > 0:
        comportamiento, emoji = "CONVEXA", "ðŸ”´"
    else:
        comportamiento, emoji = "CONCAVA", "ðŸŸ¢"

    t_smooth = list(np.linspace(min(tiempos), max(tiempos), 200))
    H_smooth = list(np.polyval(coef, t_smooth))

    return json.dumps({
        "tiempos": tiempos,
        "H": H,
        "t_smooth": t_smooth,
        "H_smooth": H_smooth,
        "n": n,
        "tiempo_max": max(tiempos),
        "H_final": round(H[-1],4),
        "comportamiento": comportamiento,
        "emoji": emoji
    })
`;

async function ejecutarAnalisis() {

  const horasStr = document.getElementById("horas-input").value.trim();
  const errorDiv = document.getElementById("error-msg");
  errorDiv.innerText = "";

  if (!horasStr) {
    errorDiv.innerText = "Ingresa datos vÃ¡lidos.";
    return;
  }

  try {
    await pyodide.runPythonAsync(codigoPython);
    const resultadoStr = await pyodide.runPythonAsync(`analizar("${horasStr}")`);
    const d = JSON.parse(resultadoStr);

    document.getElementById("res-fallas").innerText = d.n;
    document.getElementById("res-tiempo").innerText = d.tiempo_max + " h";
    document.getElementById("res-riesgo").innerText = d.H_final;
    document.getElementById("res-comportamiento").innerText = d.emoji + " " + d.comportamiento;

    Plotly.newPlot("grafico", [
      {
        x: d.tiempos,
        y: d.H,
        mode: "lines",
        line: {shape:"hv", width:3},
        name:"Nelson-Aalen"
      },
      {
        x: d.t_smooth,
        y: d.H_smooth,
        mode:"lines",
        line:{dash:"dot"},
        name:"Tendencia"
      }
    ]);

    document.getElementById("resultados").style.display = "block";

  } catch(e) {
    errorDiv.innerText = e.message;
  }
}
</script>

</body>
</html>