<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>An√°lisis de Confiabilidad ‚Äî Nelson-Aalen</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #1c2b2b; color: #e8ede8; font-family: 'Inter', system-ui, sans-serif; min-height: 100vh; }

    header { background: #162020; padding: 32px 24px; text-align: center; border-bottom: 2px solid #7a9e7e; }
    header h1 { font-size: 2rem; color: #a8c5a0; }
    header p  { color: #7a9e7e; margin-top: 6px; font-size: 1rem; letter-spacing: 0.05em; }

    .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }

    .card { background: #1e2e2e; border-radius: 10px; padding: 28px; margin-bottom: 28px; border: 1px solid #2e4040; }

    label { display: block; margin-bottom: 8px; color: #9ab89a; font-size: 0.9rem; font-weight: 600; }

    textarea, input[type="text"] {
      width: 100%; padding: 12px; border-radius: 8px;
      background: #162020; border: 1px solid #3d5c3d;
      color: #e8ede8; font-size: 1rem; resize: vertical;
      margin-bottom: 16px;
    }
    textarea:focus, input[type="text"]:focus { outline: none; border-color: #7a9e7e; }

    .btn-primary {
      width: 100%; padding: 14px; background: #3d6b45; color: #e8ede8;
      border: none; border-radius: 8px; font-size: 1rem; font-weight: 700;
      cursor: pointer; transition: background 0.2s; letter-spacing: 0.03em;
    }
    .btn-primary:hover:not(:disabled) { background: #4e8a58; }
    .btn-primary:disabled { background: #2a3d2a; color: #555; cursor: not-allowed; }

    .btn-secondary {
      width: 100%; padding: 12px; background: transparent; color: #9ab89a;
      border: 1px solid #3d5c3d; border-radius: 8px; font-size: 0.95rem;
      cursor: pointer; margin-top: 10px; transition: background 0.2s;
    }
    .btn-secondary:hover { background: #162020; }

    .spinner { display: flex; align-items: center; gap: 12px; color: #7a9e7e; font-size: 0.95rem; margin-bottom: 16px; }
    .spinner-circle { width: 20px; height: 20px; border: 3px solid #2e4040; border-top-color: #7a9e7e; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error-msg { background: #2e1a1a; border: 1px solid #7a3a3a; color: #c49a9a; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 0.9rem; }

    .metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 8px; }
    .metric { background: #162020; border-radius: 8px; padding: 16px; text-align: center; border: 1px solid #2e4040; }
    .metric-label { font-size: 0.78rem; color: #7a9e7e; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.08em; }
    .metric-value { font-size: 1.4rem; font-weight: 700; color: #a8c5a0; }

    .section-title { font-size: 1rem; font-weight: 700; color: #a8c5a0; margin-bottom: 16px; border-bottom: 1px solid #2e4040; padding-bottom: 8px; text-transform: uppercase; letter-spacing: 0.08em; }

    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th { background: #162020; color: #a8c5a0; padding: 10px; text-align: center; text-transform: uppercase; font-size: 0.78rem; letter-spacing: 0.06em; }
    td { padding: 8px 10px; text-align: center; border-bottom: 1px solid #2e4040; color: #c8d8c8; }
    tr:hover td { background: #1e3030; }

    .toggle-btn { background: none; border: none; color: #7a9e7e; cursor: pointer; font-size: 0.9rem; margin-bottom: 12px; padding: 0; }
    .toggle-btn:hover { color: #a8c5a0; }

    #resultados { display: none; }
    #spinner-carga { display: none; }
    #spinner-calculo { display: none; }
  </style>
</head>
<body>

<header>
  <h1>An√°lisis de Confiabilidad</h1>
  <p>Nelson-Aalen ¬∑ Estimador de Riesgo Acumulado</p>
</header>

<div class="container">

  <!-- CARGA INICIAL -->
  <div class="card" id="spinner-carga">
    <div class="spinner">
      <div class="spinner-circle"></div>
      Cargando motor de an√°lisis... (primera vez puede tardar ~20 segundos)
    </div>
  </div>

  <!-- EXPLICACI√ìN -->
  <div class="card">
    <div class="section-title">¬øQu√© es el diagrama de Nelson-Aalen?</div>
    <p style="line-height: 1.8; color: #c8d8c8; font-size: 0.97rem;">
      El diagrama de <strong style="color:#a8c5a0;">Nelson-Aalen</strong> es una herramienta gr√°fica utilizada en mantenimiento
      para analizar la confiabilidad de sistemas reparables. Permite visualizar la acumulaci√≥n de fallas frente al tiempo
      de operaci√≥n para determinar si la frecuencia de fallas
      <strong style="color:#e07070;">aumenta (deterioro)</strong>,
      <strong style="color:#7ab87a;">disminuye</strong> o
      <strong style="color:#c8b870;">se mantiene constante</strong>.
    </p>
  </div>

  <!-- PANEL DE ENTRADA -->
  <div class="card" id="panel-entrada">
    <div class="section-title">Datos de entrada</div>

    <label for="nombre-rack">Nombre del equipo (opcional)</label>
    <input type="text" id="nombre-rack" placeholder="Ej: Planta, Bomba, Compresor..." />

    <label for="horas-input">Horas de falla (separadas por coma)</label>
    <textarea id="horas-input" rows="3" placeholder="Ej: 120, 340, 780, 1200, 2100"></textarea>

    <div id="error-msg" class="error-msg" style="display:none;"></div>

    <div id="spinner-calculo">
      <div class="spinner">
        <div class="spinner-circle"></div>
        Calculando...
      </div>
    </div>

    <button class="btn-primary" id="btn-analizar" onclick="ejecutarAnalisis()" disabled>
      ‚è≥ Cargando motor...
    </button>
    <button class="btn-secondary" id="btn-limpiar" onclick="limpiar()" style="display:none;">
      ‚úï Limpiar
    </button>
  </div>

  <!-- RESULTADOS -->
  <div id="resultados">

    <div class="card">
      <div class="section-title">Resumen del an√°lisis</div>
      <div class="metrics">
        <div class="metric"><div class="metric-label">Fallas totales</div><div class="metric-value" id="res-fallas">‚Äî</div></div>
        <div class="metric"><div class="metric-label">Tiempo observado</div><div class="metric-value" id="res-tiempo">‚Äî</div></div>
        <div class="metric"><div class="metric-label">Riesgo acumulado H(t)</div><div class="metric-value" id="res-riesgo">‚Äî</div></div>
        <div class="metric"><div class="metric-label">Comportamiento</div><div class="metric-value" id="res-comportamiento">‚Äî</div></div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">Estimador Nelson-Aalen</div>
      <div id="grafico-nelson" style="height:520px;"></div>
    </div>

    <div class="card">
      <button class="toggle-btn" onclick="toggleTabla()">‚ñº Ver tabla detallada</button>
      <div id="tabla-container" style="display:none; overflow-x:auto;">
        <table>
          <thead><tr><th>N¬∞ Falla</th><th>Tiempo (h)</th><th>En Riesgo</th><th>Incremento</th><th>H(t)</th></tr></thead>
          <tbody id="tabla-body"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
let pyodide = null;

async function cargarPyodide() {
  document.getElementById("spinner-carga").style.display = "block";
  pyodide = await loadPyodide();
  await pyodide.loadPackage(["numpy", "scipy"]);
  document.getElementById("spinner-carga").style.display = "none";
  const btn = document.getElementById("btn-analizar");
  btn.disabled = false;
  btn.textContent = "‚ñ∂ Analizar";
}
cargarPyodide();

const codigoPython = `
import numpy as np
from scipy import stats
from scipy.interpolate import make_interp_spline
import json

def analizar(tiempos_str):
    tiempos = sorted([float(x.strip()) for x in tiempos_str.split(",") if x.strip()])
    n = len(tiempos)

    # Nelson-Aalen
    H = list(np.cumsum([1/(n-i) for i in range(n)]))

    # Ajuste lineal
    slope, intercept, r_val, _, _ = stats.linregress(tiempos, H)
    linea_lineal = [slope*t + intercept for t in tiempos]
    r2_lineal = r_val**2

    # Ajuste polinomial grado 2
    coef = np.polyfit(tiempos, H, 2)
    linea_poly = list(np.polyval(coef, tiempos))
    residuos = np.array(H) - np.array(linea_poly)
    ss_res = float(np.sum(residuos**2))
    ss_tot = float(np.sum((np.array(H) - np.mean(H))**2))
    r2_poly = 1 - (ss_res / ss_tot) if ss_tot > 0 else 1.0

    a, b = float(coef[0]), float(coef[1])

    # Clasificacion
    mejora_r2 = r2_poly - r2_lineal
    t_range = max(tiempos) - min(tiempos)
    denom = b + a * t_range / 2
    cambio_relativo = abs(2*a*t_range / denom) if abs(denom) > 1e-10 else 0
    rango_H = max(H) - min(H)
    curvatura_norm = abs(a * t_range**2 / rango_H) if rango_H > 0 and t_range > 0 else 0

    es_lineal = mejora_r2 < 0.01 and cambio_relativo < 0.05 and curvatura_norm < 0.03

    if es_lineal:
        comportamiento, emoji, interpretacion = "LINEAL", "üü°", "Tasa de fallas constante (Vida util)"
    elif a > 0:
        comportamiento, emoji, interpretacion = "CONVEXA", "üî¥", "Tasa de fallas creciente (Desgaste)"
    else:
        comportamiento, emoji, interpretacion = "CONCAVA", "üü¢", "Tasa de fallas decreciente (Mejora)"

    # Spline suavizada para la tendencia (curva continua con mas puntos)
    t_arr = np.array(tiempos)
    if n >= 4:
        k = min(3, n - 1)
        spline = make_interp_spline(t_arr, np.array(H), k=k)
        t_smooth = np.linspace(t_arr[0], t_arr[-1], 300)
        H_smooth = list(spline(t_smooth))
        t_smooth = list(t_smooth)
    else:
        t_smooth = list(np.linspace(t_arr[0], t_arr[-1], 100))
        t_smooth_arr = np.array(t_smooth)
        H_smooth = list(np.polyval(coef, t_smooth_arr))

    return json.dumps({
        "tiempos": tiempos,
        "H": H,
        "t_smooth": t_smooth,
        "H_smooth": H_smooth,
        "comportamiento": comportamiento,
        "emoji": emoji,
        "interpretacion": interpretacion,
        "n_fallas": n,
        "tiempo_max": max(tiempos),
        "H_final": round(H[-1], 4),
        "r2_lineal": round(r2_lineal, 4),
        "r2_poly": round(r2_poly, 4),
        "tabla": [{"falla": i+1, "tiempo": tiempos[i], "en_riesgo": n-i,
                   "incremento": round(1/(n-i), 6), "H": round(H[i], 6)} for i in range(n)]
    })
`;

async function ejecutarAnalisis() {
  const horasStr = document.getElementById("horas-input").value.trim();
  const errorDiv = document.getElementById("error-msg");
  errorDiv.style.display = "none";

  if (!horasStr) { mostrarError("‚ö† Ingresa al menos 3 horas de falla separadas por coma."); return; }
  const partes = horasStr.split(",").filter(x => x.trim() !== "");
  if (partes.some(x => isNaN(parseFloat(x)))) { mostrarError("‚ö† Verifica que los datos sean solo n√∫meros separados por coma."); return; }
  if (partes.length < 3) { mostrarError("‚ö† Ingresa al menos 3 horas de falla para el an√°lisis."); return; }

  document.getElementById("spinner-calculo").style.display = "block";
  document.getElementById("btn-analizar").disabled = true;

  try {
    await pyodide.runPythonAsync(codigoPython);
    const resultadoStr = await pyodide.runPythonAsync(`analizar("${horasStr}")`);
    const d = JSON.parse(resultadoStr);
    mostrarResultados(d);
  } catch(e) {
    mostrarError("‚ö† Error en el c√°lculo: " + e.message);
  } finally {
    document.getElementById("spinner-calculo").style.display = "none";
    document.getElementById("btn-analizar").disabled = false;
  }
}

function mostrarResultados(d) {
  const rack = document.getElementById("nombre-rack").value.trim() || "Equipo";

  // M√©tricas
  document.getElementById("res-fallas").textContent = d.n_fallas;
  document.getElementById("res-tiempo").textContent = d.tiempo_max.toFixed(1) + " h";
  document.getElementById("res-riesgo").textContent = d.H_final;
  document.getElementById("res-comportamiento").textContent = d.emoji + " " + d.comportamiento;

  // Color de tendencia seg√∫n comportamiento
  const colorTendencia = d.comportamiento === "CONVEXA" ? "#e07070"
                       : d.comportamiento === "CONCAVA" ? "#7ab87a"
                       : "#c8b870";

  // Gr√°fico Nelson-Aalen
  Plotly.newPlot("grafico-nelson", [
    {
      // L√≠nea escalonada N(t) ‚Äî gruesa y visible
      x: d.tiempos,
      y: d.H,
      mode: "lines",
      line: { shape: "hv", color: "#a8c5a0", width: 3 },
      name: "N(t) ‚Äî Nelson-Aalen"
    },
    {
      // Tendencia spline suavizada
      x: d.t_smooth,
      y: d.H_smooth,
      mode: "lines",
      line: { color: colorTendencia, width: 2.5, dash: "dot" },
      name: "W(t) ‚Äî Tendencia"
    }
  ], {
    paper_bgcolor: "#162020",
    plot_bgcolor: "#162020",
    font: { color: "#c8d8c8", family: "Inter, system-ui" },
    xaxis: {
      title: { text: "Tiempo acumulado (horas)", font: { size: 13 } },
      gridcolor: "#2e4040", zerolinecolor: "#2e4040"
    },
    yaxis: {
      title: { text: "Riesgo acumulado H(t)", font: { size: 13 } },
      gridcolor: "#2e4040", zerolinecolor: "#2e4040"
    },
    title: {
      text: `Estimador Nelson-Aalen ‚Äî ${rack}<br><sub>${d.comportamiento}: ${d.interpretacion}</sub>`,
      font: { size: 15, color: "#a8c5a0" }
    },
    legend: {
      orientation: "h", y: -0.18,
      bgcolor: "rgba(0,0,0,0)", font: { size: 12 }
    },
    margin: { t: 90, b: 80, l: 70, r: 30 }
  }, { responsive: true });

  // Tabla
  const tbody = document.getElementById("tabla-body");
  tbody.innerHTML = d.tabla.map(r =>
    `<tr><td>${r.falla}</td><td>${r.tiempo}</td><td>${r.en_riesgo}</td><td>${r.incremento}</td><td>${r.H}</td></tr>`
  ).join("");

  document.getElementById("resultados").style.display = "block";
  document.getElementById("btn-limpiar").style.display = "block";
  document.getElementById("resultados").scrollIntoView({ behavior: "smooth" });
}

function mostrarError(msg) {
  const div = document.getElementById("error-msg");
  div.textContent = msg;
  div.style.display = "block";
}

function limpiar() {
  document.getElementById("horas-input").value = "";
  document.getElementById("nombre-rack").value = "";
  document.getElementById("error-msg").style.display = "none";
  document.getElementById("resultados").style.display = "none";
  document.getElementById("btn-limpiar").style.display = "none";
  document.getElementById("tabla-container").style.display = "none";
}

function toggleTabla() {
  const c = document.getElementById("tabla-container");
  const btn = document.querySelector(".toggle-btn");
  if (c.style.display === "none") {
    c.style.display = "block";
    btn.textContent = "‚ñ≤ Ocultar tabla";
  } else {
    c.style.display = "none";
    btn.textContent = "‚ñº Ver tabla detallada";
  }
}
</script>
</body>
</html>